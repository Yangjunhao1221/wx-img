# 抽屉两层模式说明

## 📅 更新日期
2025-11-07

---

## 🎯 核心设计

### 收起状态（collapsed）
- **抽屉高度**：100px（从60px调整）
- **画布高度**：屏幕高度 - 顶部栏 - 抽屉高度（100px）
- **视觉效果**：抽屉收起，显示Tab栏，高度适中

### 第一层（半展开，half）
- **抽屉高度**：300px（固定）
- **画布高度**：屏幕高度 - 顶部栏 - 抽屉高度（300px）
- **视觉效果**：画布被压缩，抽屉在底部，**两者不重叠**
- **实际实现**：抽屉仍然是 `position: fixed`，但画布区域高度动态调整

### 第二层（全展开，full）
- **抽屉高度**：80%屏幕高度（从70%调整）
- **画布高度**：屏幕高度 - 顶部栏（100%可用空间）
- **视觉效果**：画布恢复100%高度，抽屉**覆盖**在画布上方
- **实际实现**：抽屉 `position: fixed` 覆盖在画布上

---

## 📐 布局示意图

### 第一层（half）- 画布被压缩
```
┌─────────────────────────────────┐
│      状态栏 + 导航栏             │ ← 87px
├─────────────────────────────────┤
│                                 │
│         画布区域                 │ ← 425px (被压缩)
│      (725 - 300 = 425px)        │
│                                 │
├─────────────────────────────────┤
│                                 │
│      抽屉（第一层）              │ ← 300px
│                                 │
└─────────────────────────────────┘
```

### 第二层（full）- 抽屉覆盖画布
```
┌─────────────────────────────────┐
│      状态栏 + 导航栏             │ ← 87px
├─────────────────────────────────┤
│                                 │
│         画布区域                 │ ← 725px (100%)
│         (100%高度)              │
│                                 │
│    ┌─────────────────────┐     │
│    │                     │     │
│    │  抽屉（第二层）      │     │ ← 675.2px (80%)
│    │   覆盖在画布上       │     │    覆盖在画布上
│    │                     │     │
│    └─────────────────────┘     │
└─────────────────────────────────┘
```

---

## 🔢 高度计算公式（iPhone 12示例）

### 基础数据
```
windowHeight = 844px
statusBarHeight = 47px
navigationBarHeight = 40px
topBarHeight = 87px
```

### 第一层（half）
```javascript
drawerHeight = 300px
canvasAreaHeight = windowHeight - topBarHeight - drawerHeight
                 = 844 - 87 - 300
                 = 457px
```

**结果**：
- 抽屉高度：300px
- 画布高度：457px
- 两者不重叠 ✅

### 第二层（full）
```javascript
drawerHeight = windowHeight * 0.8
             = 844 * 0.8
             = 675.2px

canvasAreaHeight = windowHeight - topBarHeight
                 = 844 - 87
                 = 757px
```

**结果**：
- 抽屉高度：675.2px
- 画布高度：757px
- 抽屉覆盖在画布上 ✅

---

## 💻 代码实现

### 1. WXML - 动态高度

```xml
<!-- 画布区域 - 根据抽屉状态动态调整高度 -->
<view class="canvas-area-flex" 
      style="height: {{drawerState === 'full' 
        ? 'calc(100vh - ' + (statusBarHeight + navigationBarHeight) + 'px)' 
        : 'calc(100vh - ' + (statusBarHeight + navigationBarHeight + drawerHeight) + 'px)'}}">
```

**逻辑**：
- `drawerState === 'full'`：画布100%高度
- 其他状态：画布高度 = 100vh - 顶部栏 - 抽屉高度

---

### 2. JS - expandDrawer 方法

```javascript
expandDrawer (state) {
  const { windowHeight } = this.data;
  let drawerHeight = 100; // 收起时高度从60改为100

  if (state === 'half') {
    // 第一层：300px，画布被压缩
    drawerHeight = 300;
  } else if (state === 'full') {
    // 第二层：80%屏幕高度，画布恢复100%，抽屉覆盖在画布上
    drawerHeight = windowHeight * 0.8;
  }

  this.setData({
    drawerState: state,
    drawerHeight: drawerHeight
  }, () => {
    this.updateCanvasSizeForDrawer();
  });
}
```

---

### 3. JS - updateCanvasSizeForDrawer 方法

```javascript
updateCanvasSizeForDrawer () {
  const { drawerHeight, drawerState, statusBarHeight, navigationBarHeight } = this.data;
  const windowInfo = wx.getWindowInfo();
  const screenHeight = windowInfo.screenHeight;
  
  const topBarHeight = statusBarHeight + navigationBarHeight;
  const verticalMargin = 32;
  let availableHeight;

  // 根据抽屉状态决定画布高度
  if (drawerState === 'full') {
    // 第二层：画布恢复100%高度，抽屉覆盖在画布上
    availableHeight = screenHeight - topBarHeight - verticalMargin;
  } else {
    // 收起/第一层：画布被压缩，抽屉在底部
    availableHeight = screenHeight - topBarHeight - drawerHeight - verticalMargin;
  }

  // 使用 availableHeight 计算画布尺寸...
}
```

---

### 4. JS - 拖动时动态更新状态

```javascript
onDrawerTouchMove (e) {
  const touch = e.touches[0];
  const deltaY = drawerTouchStartY - touch.clientY;
  const newHeight = drawerTouchStartHeight + deltaY;

  // 限制高度范围
  const minHeight = 60;
  const maxHeight = windowHeight * 0.7;
  const clampedHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));

  // 判断当前应该是哪个状态
  let currentState = 'collapsed';
  if (clampedHeight >= windowHeight * 0.5) {
    currentState = 'full'; // 超过50%屏幕高度，进入第二层
  } else if (clampedHeight > 150) {
    currentState = 'half'; // 第一层
  }

  // 实时更新抽屉高度和状态
  this.setData({
    drawerHeight: clampedHeight,
    drawerState: currentState
  });
}
```

**关键点**：
- 当抽屉高度 ≥ 50%屏幕高度时，自动切换到 `full` 状态
- 这样画布会立即恢复100%高度，抽屉开始覆盖画布

---

## 🔄 状态转换

### 收起 → 第一层
```
用户点击Tab或拖动
  ↓
drawerHeight: 60px → 300px
drawerState: 'collapsed' → 'half'
  ↓
画布高度: 725px → 425px (被压缩)
```

### 第一层 → 第二层
```
用户继续向上拖动
  ↓
drawerHeight: 300px → 422px (超过50%屏幕高度)
drawerState: 'half' → 'full'
  ↓
画布高度: 425px → 725px (恢复100%)
抽屉开始覆盖画布
  ↓
继续拖动
  ↓
drawerHeight: 422px → 590.8px (70%屏幕高度)
```

### 第二层 → 第一层
```
用户向下拖动
  ↓
drawerHeight: 590.8px → 422px (低于50%屏幕高度)
drawerState: 'full' → 'half'
  ↓
画布高度: 725px → 425px (被压缩)
抽屉不再覆盖画布
  ↓
继续拖动
  ↓
drawerHeight: 422px → 300px
```

---

## 📊 数据对比表

| 状态 | 抽屉高度 | 画布高度 | 是否重叠 | 画布可见比例 |
|------|---------|---------|---------|-------------|
| 收起 | 100px | 685px | 否 | 100% |
| 第一层 | 300px | 425px | 否 | 100% |
| **过渡点** | **422px** | **725px** | **开始** | **100%** |
| 第二层 | 675.2px | 725px | 是 | 6.9% |

**过渡点**：当抽屉高度达到50%屏幕高度（422px）时，状态从 `half` 切换到 `full`，画布立即恢复100%高度。

---

## ✅ 优势

### 1. 第一层体验更好
- 画布和抽屉不重叠，视觉上清晰分离
- 用户可以同时看到画布和操作区域
- 画布虽然被压缩，但仍然完整可见

### 2. 第二层操作空间充足
- 抽屉高度达到70%屏幕高度（590.8px）
- 操作区域非常充足
- 画布恢复100%高度，不会变形

### 3. 平滑过渡
- 拖动过程中，状态自动切换
- 画布高度平滑变化
- 用户体验流畅

---

## 🧪 测试步骤

### 测试1：第一层 - 画布被压缩
1. 点击"模版"Tab
2. **观察**：
   - 抽屉高度是否为300px？
   - 画布高度是否变小（约425px）？
   - 画布和抽屉是否不重叠？

### 测试2：第二层 - 抽屉覆盖画布
1. 在第一层基础上，继续向上拖动
2. **观察**：
   - 当抽屉高度超过50%屏幕高度时，画布是否立即恢复100%高度？
   - 抽屉是否覆盖在画布上？
   - 最终抽屉高度是否为70%屏幕高度（约590px）？

### 测试3：智能拖动
1. 在第一层，内容区域向上滑动
2. **观察**：
   - 是否可以展开到第二层？
   - 画布是否正确恢复100%高度？

---

## 🎉 完成状态

所有功能已实现！

**关键特性**：
- ✅ 第一层：画布被压缩（300px抽屉，425px画布）
- ✅ 第二层：抽屉覆盖画布（590.8px抽屉，725px画布）
- ✅ 拖动时自动切换状态（50%屏幕高度为分界点）
- ✅ 智能拖动功能正常
- ✅ 平滑过渡动画

**下一步**：
请在微信开发者工具中测试，确保所有功能正常工作！

