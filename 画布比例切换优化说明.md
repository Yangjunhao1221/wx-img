# 画布比例切换优化说明

## 🎯 优化目标

修复画布比例切换时的问题：
- ✅ 重新计算每张图片所占的大小
- ✅ 更新画布中加号（占位框）的位置和大小
- ✅ 确保图片和占位框都按新比例正确显示

---

## 🔧 问题分析

### 之前的问题

当用户切换画布比例时：

```javascript
// 之前的代码
onAspectRatioChange (e) {
  const ratio = this.data.aspectRatios.find(r => r.value === ratioValue);
  if (ratio) {
    this.setData({ aspectRatio: ratio.value });
    this.calculateCanvasSize(ratio.width, ratio.height);  // ← 只计算了画布尺寸
  }
  
  if (this.data.currentLayoutTemplate) {
    this.updateCanvas();  // ← 立即调用，但画布尺寸可能还没更新完
  }
}
```

**问题**:
1. ❌ `setData` 是异步的，`calculateCanvasSize` 中的 `setData` 可能还没完成
2. ❌ `updateCanvas` 使用的可能是旧的 `canvasWidth` 和 `canvasHeight`
3. ❌ 导致图片位置和占位框位置计算错误

---

## ✅ 解决方案

### 1. 使用 setData 回调确保顺序

```javascript
onAspectRatioChange (e) {
  const that = this;
  const ratio = this.data.aspectRatios.find(r => r.value === ratioValue);
  
  if (ratio) {
    // 第一步：设置新比例
    this.setData({
      aspectRatio: ratio.value
    }, () => {
      // 第二步：计算新的画布尺寸
      that.calculateCanvasSize(ratio.width, ratio.height);
      
      // 第三步：等待画布尺寸更新后，重新绘制
      setTimeout(() => {
        if (that.data.currentLayoutTemplate) {
          const hasImages = that.data.imageSlots && 
                           that.data.imageSlots.some(slot => !slot.isEmpty);
          
          if (hasImages) {
            // 有图片：重新计算位置并绘制图片
            that.updateCanvas();
          } else {
            // 无图片：重新计算位置并绘制占位框
            that.drawPlaceholders();
          }
        }
      }, 50);
    });
  }
}
```

### 2. 重新计算布局位置

在 `updateCanvas` 和 `drawPlaceholders` 中，都会调用 `calculateLayout` 重新计算位置：

```javascript
// updateCanvas 中
const imagePositions = calculateLayout(
  currentLayoutTemplate,
  canvasWidth,        // ← 使用新的画布尺寸
  canvasHeight,       // ← 使用新的画布尺寸
  spacing,
  currentLayoutTemplate.imageCount
);

// 更新位置信息
this.setData({
  imagePositions: imagePositions
});
```

```javascript
// drawPlaceholders 中
const positions = calculateLayout(
  currentLayoutTemplate,
  canvasWidth,        // ← 使用新的画布尺寸
  canvasHeight,       // ← 使用新的画布尺寸
  spacing,
  currentLayoutTemplate.imageCount
);

// 保存位置信息
this.setData({
  imagePositions: positions
});
```

### 3. 添加日志便于调试

```javascript
calculateCanvasSize (width, height) {
  // ... 计算逻辑 ...
  
  const newCanvasWidth = Math.floor(canvasWidth);
  const newCanvasHeight = Math.floor(canvasHeight);

  console.log('计算新画布尺寸:', newCanvasWidth, 'x', newCanvasHeight);

  this.setData({
    canvasWidth: newCanvasWidth,
    canvasHeight: newCanvasHeight
  });
}
```

---

## 📊 执行流程

### 完整的执行流程

```
用户点击比例选项 (例如: 3:4)
    ↓
onAspectRatioChange 被调用
    ↓
setData({ aspectRatio: '3:4' })
    ↓
[等待 setData 完成]
    ↓
calculateCanvasSize(3, 4)
    ↓
计算新尺寸: 350 x 467
    ↓
setData({ canvasWidth: 350, canvasHeight: 467 })
    ↓
[等待 50ms，确保 setData 完成]
    ↓
检查是否有图片
    ↓
┌─────────────┴─────────────┐
│                           │
有图片                    无图片
│                           │
updateCanvas()          drawPlaceholders()
│                           │
calculateLayout()       calculateLayout()
│                           │
使用新的 canvasWidth    使用新的 canvasWidth
和 canvasHeight         和 canvasHeight
│                           │
重新计算每张图片        重新计算每个占位框
的位置和尺寸            的位置和尺寸
│                           │
绘制图片                绘制占位框和加号
│                           │
└─────────────┬─────────────┘
              ↓
    显示 Toast: "已切换到 3:4 竖版"
              ↓
          完成 ✅
```

---

## 🧪 测试场景

### 场景1: 无图片时切换比例

**步骤**:
1. 选择布局 "2×2网格 4张"
2. 不上传图片
3. 切换比例到 "3:4 竖版"

**预期结果**:
- ✅ Canvas 变为竖版（高度 > 宽度）
- ✅ 4个占位框重新排列
- ✅ 每个占位框的尺寸按新比例计算
- ✅ 加号位置居中
- ✅ 序号位置正确

**验证方法**:
```javascript
// 在控制台查看
const page = getCurrentPages()[getCurrentPages().length-1];
console.log('画布尺寸:', page.data.canvasWidth, 'x', page.data.canvasHeight);
console.log('图片位置:', page.data.imagePositions);
```

---

### 场景2: 有图片时切换比例

**步骤**:
1. 选择布局 "2×2网格 4张"
2. 上传4张图片
3. 切换比例到 "9:16 手机竖屏"

**预期结果**:
- ✅ Canvas 变为细长竖版
- ✅ 4张图片重新排列
- ✅ 每张图片的尺寸按新比例计算
- ✅ 图片间距保持一致
- ✅ 图片不变形（根据 imageFitMode）

**验证方法**:
观察图片是否：
- 位置正确
- 尺寸合适
- 间距均匀
- 不超出画布

---

### 场景3: 多次切换比例

**步骤**:
1. 选择布局并上传图片
2. 切换到 "1:1 正方形"
3. 切换到 "3:4 竖版"
4. 切换到 "16:9 横版"
5. 切换到 "A4 纸张"

**预期结果**:
- ✅ 每次切换都正确重新计算
- ✅ 图片不丢失
- ✅ 布局结构保持不变
- ✅ 没有性能问题

---

### 场景4: 不同布局类型

**步骤**:
1. 测试网格布局（如 2×2、3×3）
2. 测试自定义布局（如上大下小）
3. 每种布局都切换不同比例

**预期结果**:
- ✅ 网格布局：格子均匀分布
- ✅ 自定义布局：按 positions 比例正确计算
- ✅ 所有布局都能正确适应新比例

---

## 🔍 关键代码位置

### 1. 比例切换入口
**文件**: `pages/collage/collage.js`  
**行数**: 468-530  
**方法**: `onAspectRatioChange`

### 2. 画布尺寸计算
**文件**: `pages/collage/collage.js`  
**行数**: 532-572  
**方法**: `calculateCanvasSize`

### 3. 布局位置计算
**文件**: `utils/layoutCalculator.js`  
**行数**: 15-27  
**方法**: `calculateLayout`

### 4. 绘制图片
**文件**: `pages/collage/collage.js`  
**行数**: 573-710  
**方法**: `updateCanvas`

### 5. 绘制占位框
**文件**: `pages/collage/collage.js`  
**行数**: 712-798  
**方法**: `drawPlaceholders`

---

## 📝 技术细节

### 1. 为什么使用 setTimeout(50ms)？

```javascript
setTimeout(() => {
  that.updateCanvas();
}, 50);
```

**原因**:
- `setData` 是异步的，需要时间完成
- 50ms 是一个合理的等待时间
- 太短可能获取到旧值，太长用户会感觉卡顿

### 2. 为什么区分有图片和无图片？

```javascript
const hasImages = that.data.imageSlots && 
                 that.data.imageSlots.some(slot => !slot.isEmpty);

if (hasImages) {
  that.updateCanvas();
} else {
  that.drawPlaceholders();
}
```

**原因**:
- `updateCanvas`: 绘制实际图片，性能开销较大
- `drawPlaceholders`: 只绘制占位框，性能开销小
- 根据实际情况选择，提升性能

### 3. 布局位置如何计算？

**网格布局**:
```javascript
const cellWidth = (canvasWidth - spacing * (cols + 1)) / cols;
const cellHeight = (canvasHeight - spacing * (rows + 1)) / rows;

const x = spacing + col * (cellWidth + spacing);
const y = spacing + row * (cellHeight + spacing);
```

**自定义布局**:
```javascript
const x = pos.x * canvasWidth + spacing;
const y = pos.y * canvasHeight + spacing;
const width = pos.width * canvasWidth - spacing * 2;
const height = pos.height * canvasHeight - spacing * 2;
```

---

## ⚠️ 注意事项

### 1. 性能优化
- ✅ 使用 setTimeout 避免频繁重绘
- ✅ 区分有图片和无图片场景
- ✅ 只在必要时重新计算位置

### 2. 边界情况
- ✅ 画布尺寸不超出屏幕
- ✅ 极端比例（如 1:10）也能正确显示
- ✅ 图片数量为0时不报错

### 3. 用户体验
- ✅ 显示 Toast 提示
- ✅ 切换流畅，无闪烁
- ✅ 图片不丢失

---

## 🎉 优化效果

### 之前
```
切换比例 → 画布尺寸变化 → 图片位置错误 ❌
                      → 占位框位置错误 ❌
                      → 加号大小不对 ❌
```

### 现在
```
切换比例 → 画布尺寸变化 → 重新计算位置 → 图片位置正确 ✅
                                    → 占位框位置正确 ✅
                                    → 加号大小正确 ✅
```

---

## 🚀 总结

这次优化确保了：

1. **正确性**: 画布比例切换后，所有元素都按新尺寸重新计算
2. **完整性**: 图片、占位框、加号都正确显示
3. **流畅性**: 使用回调和延时确保执行顺序
4. **可靠性**: 添加日志便于调试和排查问题

用户现在可以自由切换画布比例，实时看到效果，所有元素都会正确适应新比例！🎨

