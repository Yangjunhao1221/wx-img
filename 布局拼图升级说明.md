# 布局拼图功能升级说明

## 📋 升级概述

本次升级将布局拼图功能从支持**1-9张图片**升级到**1-16张图片**,并为每种图片数量提供了**多种灵活的布局模板**。

---

## ✨ 主要改进

### 1. 图片数量支持扩展
- ✅ **之前**: 最多支持9张图片
- ✅ **现在**: 最多支持16张图片

### 2. 布局模板大幅增加
- ✅ **之前**: 每种图片数量1-3种布局
- ✅ **现在**: 每种图片数量3-7种布局,总计**60+种布局模板**

### 3. 布局类型更丰富
- ✅ **网格布局**: 规则的行列网格(如2×2, 3×3, 4×4等)
- ✅ **自定义布局**: 灵活的位置布局(如上1下2, 左1右3, 中心布局等)

### 4. 间距系统优化
- ✅ 支持可配置的图片间距
- ✅ 网格布局和自定义布局都正确处理间距
- ✅ 导出功能也完美支持间距

---

## 🗂️ 新增文件

### 1. `utils/layoutTemplates.js`
**布局模板定义文件**

包含1-16张图片的所有布局模板定义:

```javascript
{
  name: '布局名称',
  icon: '图标',
  type: 'grid' | 'custom',  // grid=规则网格, custom=自定义布局
  
  // grid类型使用:
  rows: 2,
  cols: 2,
  
  // custom类型使用:
  positions: [
    { x: 0, y: 0, width: 0.5, height: 0.5 },  // 相对位置(0-1)
    ...
  ]
}
```

**布局模板示例**:

#### 2张图片 (4种布局)
- 横向排列 (1×2网格)
- 竖向排列 (2×1网格)
- 上大下小 (上60% 下40%)
- 左大右小 (左60% 右40%)

#### 3张图片 (6种布局)
- 横向三列 (1×3网格)
- 竖向三行 (3×1网格)
- 上1下2
- 上2下1
- 左1右2
- 左2右1

#### 4张图片 (7种布局)
- 2×2网格
- 横向四列
- 竖向四行
- 上1下3
- 上3下1
- 左1右3
- 左3右1

#### 5张图片 (5种布局)
- 上2下3
- 上3下2
- 左2右3
- 左3右2
- 中心布局 (中心1张大图,四角4张小图)

#### 6-16张图片
- 各种网格布局 (2×3, 3×2, 3×3, 4×4等)
- 创意自定义布局 (上1中2下3, 上2中4下2等)

---

### 2. `utils/layoutCalculator.js`
**布局计算工具类**

提供布局位置计算功能:

#### 主要函数:

**`calculateLayout(layout, canvasWidth, canvasHeight, spacing, imageCount)`**
- 根据布局模板计算每张图片的实际位置和尺寸
- 支持grid和custom两种布局类型
- 正确处理间距参数

**`calculateGridLayout(layout, canvasWidth, canvasHeight, spacing, imageCount)`**
- 计算规则网格布局
- 自动计算单元格尺寸
- 考虑间距的影响

**`calculateCustomLayout(layout, canvasWidth, canvasHeight, spacing, imageCount)`**
- 计算自定义布局
- 将相对位置(0-1)转换为绝对像素位置
- 处理内外边距

**`calculateImageFit(imageWidth, imageHeight, cellWidth, cellHeight, mode)`**
- 计算图片在单元格内的适配位置
- 支持'cover'和'contain'两种模式
- 保持图片宽高比

**`getRecommendedLayout(imageCount, layouts)`**
- 根据图片数量自动推荐最佳布局
- 优先选择接近正方形的网格布局

**`validateLayout(layout, imageCount)`**
- 验证布局是否有效
- 检查布局是否能容纳指定数量的图片

---

## 🔧 修改的文件

### 1. `pages/collage/collage.js`

#### 主要修改:

**引入新模块**:
```javascript
const { getLayoutTemplates } = require('../../utils/layoutTemplates.js');
const { calculateLayout } = require('../../utils/layoutCalculator.js');
```

**更新maxImages**:
```javascript
maxImages: 16,  // 从9升级到16
```

**重构 `getAvailableLayouts()` 方法**:
- 使用 `getLayoutTemplates()` 从模板文件获取布局
- 移除硬编码的布局定义
- 添加默认网格布局作为后备

**重构 `updateCanvas()` 方法**:
- 使用 `calculateLayout()` 计算图片位置
- 支持grid和custom两种布局类型
- 正确处理间距参数
- 添加详细的日志输出

**重构 `drawImagesToCanvas()` 方法** (用于导出):
- 使用新的布局计算系统
- 确保导出的图片与预览一致
- 优化圆角处理逻辑

---

### 2. `pages/collage/collage.wxml`

#### 主要修改:

**优化布局选择器**:
```xml
<scroll-view class="layout-scroll" scroll-x enable-flex>
  <view class="layout-grid">
    <view class="layout-item {{selectedLayout === index ? 'selected' : ''}}">
      <view class="layout-preview">
        <text class="layout-icon">{{item.icon}}</text>
      </view>
      <text class="layout-name">{{item.name}}</text>
      <text class="layout-type">{{item.type === 'grid' ? '网格' : '自定义'}}</text>
    </view>
  </view>
</scroll-view>
```

**改进点**:
- 添加横向滚动支持 (`scroll-view`)
- 显示布局数量 `({{availableLayouts.length}}种)`
- 添加布局类型标签 (网格/自定义)
- 更好的视觉反馈

---

### 3. `pages/collage/collage.wxss`

#### 主要修改:

**布局滚动容器**:
```css
.layout-scroll {
  width: 100%;
  white-space: nowrap;
}
```

**布局网格**:
```css
.layout-grid {
  display: inline-flex;
  gap: 12px;
  padding: 4px 0;
}
```

**布局项**:
```css
.layout-item {
  display: inline-flex;
  flex-direction: column;
  min-width: 70px;
  flex-shrink: 0;
  border: 2px solid #e5e5e5;
}

.layout-item.selected {
  border-color: #007aff;
  background: #f0f8ff;
  box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
}
```

**布局类型标签**:
```css
.layout-type {
  font-size: 10px;
  color: #999;
  background: #f0f0f0;
  padding: 2px 6px;
  border-radius: 4px;
}

.layout-item.selected .layout-type {
  background: #007aff;
  color: white;
}
```

---

## 🎯 功能特性

### 1. 智能布局计算
- 自动根据画布尺寸和间距计算图片位置
- 支持不同宽高比的画布
- 完美处理图片间距

### 2. 灵活的布局系统
- **网格布局**: 适合规则排列
- **自定义布局**: 适合创意设计
- 易于扩展新布局

### 3. 优秀的用户体验
- 横向滚动查看所有布局
- 清晰的布局类型标识
- 选中状态高亮显示
- 平滑的动画过渡

### 4. 完整的导出支持
- 导出图片与预览完全一致
- 支持所有布局类型
- 正确处理圆角和间距

---

## 📊 布局统计

| 图片数量 | 布局数量 | 主要布局类型 |
|---------|---------|------------|
| 1张 | 1种 | 单图居中 |
| 2张 | 4种 | 横排、竖排、上下分割、左右分割 |
| 3张 | 6种 | 横排、竖排、上1下2、上2下1等 |
| 4张 | 7种 | 2×2网格、上1下3、左1右3等 |
| 5张 | 5种 | 上2下3、中心布局等 |
| 6张 | 6种 | 2×3网格、3×2网格、上1中2下3等 |
| 7张 | 4种 | 上1中3下3、上2中3下2等 |
| 8张 | 5种 | 2×4网格、4×2网格、上2中4下2等 |
| 9张 | 4种 | 3×3网格、上2中5下2、中心1周围8等 |
| 10张 | 3种 | 2×5网格、5×2网格、上3中4下3 |
| 11张 | 2种 | 上3中5下3、3×4网格 |
| 12张 | 4种 | 3×4网格、4×3网格、2×6网格、6×2网格 |
| 13-16张 | 2-3种 | 各种网格布局 |
| **总计** | **60+种** | - |

---

## 🧪 测试建议

### 1. 基础功能测试
- [ ] 选择1-16张图片,验证布局选项正确显示
- [ ] 切换不同布局,验证图片位置正确
- [ ] 调整间距,验证布局正确更新
- [ ] 调整圆角,验证效果正确

### 2. 布局类型测试
- [ ] 测试所有网格布局 (1×2, 2×2, 3×3等)
- [ ] 测试所有自定义布局 (上1下2, 中心布局等)
- [ ] 验证图片在单元格内居中显示
- [ ] 验证图片保持宽高比

### 3. 导出功能测试
- [ ] 导出不同布局的图片
- [ ] 验证导出图片与预览一致
- [ ] 测试高清JPG、标准JPG、PNG格式
- [ ] 验证圆角和间距正确导出

### 4. 边界情况测试
- [ ] 测试极小间距 (0px)
- [ ] 测试极大间距 (50px)
- [ ] 测试不同宽高比的画布
- [ ] 测试不同尺寸的图片

---

## 🚀 后续优化建议

### 1. 布局预览图标
- 为每个布局生成可视化预览图标
- 使用Canvas或SVG绘制布局示意图
- 替代当前的emoji图标

### 2. 布局分类
- 将布局按类型分组 (网格/创意/特色)
- 添加分类标签页切换
- 支持布局搜索和筛选

### 3. 自定义布局编辑器
- 允许用户自定义布局
- 拖拽调整图片位置和大小
- 保存自定义布局模板

### 4. 智能布局推荐
- 根据图片比例推荐最佳布局
- 分析图片内容,智能排版
- 学习用户偏好

### 5. 性能优化
- 布局计算结果缓存
- 图片加载优化
- Canvas绘制性能优化

---

## 📝 注意事项

1. **间距配置**: 当前间距通过 `this.data.spacing` 获取,确保在后续添加间距调整功能时使用相同的数据字段

2. **布局扩展**: 如需添加新布局,只需在 `utils/layoutTemplates.js` 中添加定义即可,无需修改其他代码

3. **兼容性**: 新系统完全兼容旧代码,不影响其他功能(水印、编辑工具等)

4. **调试日志**: 代码中添加了详细的console.log,方便调试,正式发布前可以移除

---

## ✅ 完成状态

- [x] 阶段一: 布局模板设计与定义
- [x] 阶段二: 布局渲染引擎开发
- [x] 阶段三: 布局选择UI优化
- [x] 阶段四: 基础测试

**开发完成!** 🎉

现在可以在微信开发者工具中测试新功能了!

