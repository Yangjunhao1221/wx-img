# 布局拼图 - 新交互流程说明

## 🎯 核心改变

**旧流程**: 先选图片 → 再选布局  
**新流程**: 先选布局 → 再添加图片

---

## 📋 完整交互流程

### 步骤1: 选择布局模板

1. **页面加载时**,显示所有布局模板(1-16张图片,共60+种布局)
2. **用户浏览**所有布局模板,每个模板显示:
   - 图标
   - 布局名称
   - 图片数量(如"3张")
   - 布局类型("网格"或"自定义")
3. **用户点击**选择一个布局模板
4. **系统响应**:
   - 初始化对应数量的图片槽位
   - 在Canvas上绘制占位框(带+号)
   - 进入"添加图片"阶段

### 步骤2: 添加图片

用户有两种方式添加图片:

#### 方式1: 点击Canvas上的+号
1. 用户点击Canvas上某个占位框的+号
2. 系统打开图片选择器
3. 用户选择1张图片
4. 图片填充到对应的槽位
5. Canvas实时更新显示

#### 方式2: 一键上传
1. 用户点击"一键上传"按钮
2. 系统检查:
   - 是否已选择布局(未选择则提示)
   - 还能上传多少张图片(布局容量 - 已上传数量)
3. 用户选择图片(数量受限制)
4. 图片自动填充到空槽位
5. Canvas实时更新显示

### 步骤3: 编辑和导出

1. 用户可以:
   - 点击槽位替换图片
   - 点击槽位的×号移除图片
   - 调整样式(间距、圆角、背景色)
   - 点击"更换布局"重新选择(会清空图片)
2. 完成后点击"保存"导出图片

---

## 🎨 UI设计

### 布局选择界面

```
┌─────────────────────────────────────┐
│  📐 选择布局模板                      │
│  支持1-16张图片,共60种布局            │
├─────────────────────────────────────┤
│  ┌───┐  ┌───┐  ┌───┐               │
│  │ ▬ │  │ ▥ │  │ ⬒ │               │
│  │横排│  │竖排│  │上下│               │
│  │2张│  │2张│  │2张│               │
│  │网格│  │网格│  │自定义│             │
│  └───┘  └───┘  └───┘               │
│                                     │
│  ┌───┐  ┌───┐  ┌───┐               │
│  │ ▬ │  │ ▥ │  │ ⬒ │               │
│  │横排│  │竖排│  │上1下2│            │
│  │3张│  │3张│  │3张│               │
│  │网格│  │网格│  │自定义│             │
│  └───┘  └───┘  └───┘               │
│  ...更多布局...                      │
└─────────────────────────────────────┘
```

### 添加图片界面

```
┌─────────────────────────────────────┐
│  ┌─────────────────────────────┐   │
│  │ 横向排列 (2张)  [更换布局]    │   │
│  ├─────────────────────────────┤   │
│  │                             │   │
│  │  ┌──────┐    ┌──────┐      │   │
│  │  │  +   │    │ 图片 │      │   │
│  │  │  1   │    │  2   │      │   │
│  │  └──────┘    └──────┘      │   │
│  │                             │   │
│  └─────────────────────────────┘   │
├─────────────────────────────────────┤
│  图片 (1/2)          [一键上传]      │
│  ┌───┐  ┌───┐                      │
│  │ + │  │图片│                      │
│  │ 1 │  │ 2 │                      │
│  └───┘  └───┘                      │
├─────────────────────────────────────┤
│  样式                               │
│  间距: ━━━━●━━━━ 10               │
│  圆角: ━━━●━━━━━ 8                │
│  背景: [#FFFFFF]                    │
└─────────────────────────────────────┘
```

---

## 💻 技术实现

### 数据结构

```javascript
{
  // 工作流程状态
  workflowStep: 'selectLayout',  // selectLayout | addImages | editing
  
  // 当前选中的布局模板
  currentLayoutTemplate: {
    name: '横向排列',
    icon: '▬',
    type: 'grid',
    rows: 1,
    cols: 2,
    imageCount: 2
  },
  
  // 图片槽位
  imageSlots: [
    { index: 0, image: null, isEmpty: true },
    { index: 1, image: { path: '...' }, isEmpty: false }
  ],
  
  // 已选图片
  selectedImages: [
    { path: '...' }
  ],
  
  // 所有布局模板
  allLayoutTemplates: [...]
}
```

### 核心方法

#### 1. `loadAllLayoutTemplates()`
- 加载1-16张图片的所有布局模板
- 在`onLoad`时调用

#### 2. `onLayoutSelect(e)`
- 用户选择布局模板
- 初始化图片槽位
- 绘制占位框

#### 3. `drawPlaceholders()`
- 在Canvas上绘制占位框
- 每个框显示+号和序号

#### 4. `onSlotTap(e)`
- 用户点击槽位
- 空槽位:直接选择图片
- 已填充:询问是否替换

#### 5. `selectImageForSlot(slotIndex)`
- 为指定槽位选择图片
- 更新槽位数据
- 重新绘制Canvas

#### 6. `onSlotRemove(e)`
- 移除槽位中的图片
- 恢复为空槽位
- 重新绘制Canvas

#### 7. `selectImages()`
- 一键上传图片
- 检查布局限制
- 自动填充到空槽位

#### 8. `updateCanvas()`
- 根据槽位状态绘制Canvas
- 空槽位:绘制占位框
- 已填充:绘制图片

#### 9. `changeLayout()`
- 更换布局模板
- 清空已添加的图片
- 返回布局选择界面

---

## 🎯 关键特性

### 1. 布局优先
- 用户必须先选择布局
- 图片数量受布局限制
- 避免图片数量与布局不匹配

### 2. 可视化占位
- Canvas显示占位框
- 清晰标识每个位置
- 用户知道还需添加多少图片

### 3. 灵活添加
- 支持点击+号单独添加
- 支持一键批量上传
- 支持替换和移除

### 4. 实时预览
- 每次操作后立即更新Canvas
- 所见即所得
- 无需等待

### 5. 智能限制
- 一键上传时检查剩余容量
- 防止超出布局限制
- 友好的错误提示

---

## 📝 用户体验优化

### 视觉反馈
- ✅ 选中的布局模板高亮显示
- ✅ 占位框使用虚线边框
- ✅ +号清晰可见
- ✅ 已填充槽位显示序号和删除按钮
- ✅ 布局信息栏显示当前布局

### 交互反馈
- ✅ 点击布局模板有缩放动画
- ✅ 点击槽位有视觉反馈
- ✅ 操作成功显示Toast提示
- ✅ 更换布局前确认提示

### 错误处理
- ✅ 未选布局时提示先选择
- ✅ 图片已满时提示容量限制
- ✅ 选择图片失败时友好提示

---

## 🧪 测试场景

### 场景1: 基础流程
1. 打开页面,看到所有布局模板
2. 选择"横向排列(2张)"
3. Canvas显示2个占位框
4. 点击第1个+号,选择图片
5. 图片显示在第1个位置
6. 点击"一键上传",选择1张图片
7. 图片自动填充到第2个位置
8. 调整间距和圆角
9. 点击"保存"导出

### 场景2: 替换图片
1. 选择布局并添加图片
2. 点击已填充的槽位
3. 确认替换
4. 选择新图片
5. 图片更新

### 场景3: 移除图片
1. 选择布局并添加图片
2. 点击槽位上的×号
3. 图片被移除
4. 恢复为占位框

### 场景4: 更换布局
1. 选择布局并添加图片
2. 点击"更换布局"
3. 确认清空图片
4. 返回布局选择界面
5. 选择新布局

### 场景5: 一键上传限制
1. 选择"3张图片"的布局
2. 添加2张图片
3. 点击"一键上传"
4. 只能选择1张图片(剩余容量)
5. 图片填充到第3个位置
6. 再次点击"一键上传"
7. 提示"当前布局最多3张图片"

---

## 🚀 后续优化建议

### 1. Canvas点击交互
- 支持直接点击Canvas上的占位框
- 无需滚动到下方槽位列表
- 更直观的交互方式

### 2. 拖拽排序
- 支持拖拽槽位调整顺序
- 实时更新Canvas显示

### 3. 批量操作
- 支持全部清空
- 支持批量替换

### 4. 布局搜索
- 按图片数量筛选
- 按布局类型筛选
- 关键词搜索

### 5. 布局收藏
- 收藏常用布局
- 快速访问

---

## ✅ 完成状态

- [x] 布局模板展示
- [x] 布局选择交互
- [x] Canvas占位框绘制
- [x] 点击+号添加图片
- [x] 一键上传限制
- [x] 槽位管理(添加/替换/移除)
- [x] 更换布局功能
- [x] UI样式优化
- [x] 实时Canvas更新

**新交互流程开发完成!** 🎉

现在可以在微信开发者工具中测试新功能了!

