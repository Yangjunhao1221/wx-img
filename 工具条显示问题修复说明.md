# å·¥å…·æ¡æ˜¾ç¤ºé—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

### é—®é¢˜ç°è±¡
1. **å·¥å…·æ¡è¢«ç”»å¸ƒé®ä½** - å·¥å…·æ¡æ˜¾ç¤ºä¸å‡ºæ¥æˆ–è¢«å…¶ä»–å…ƒç´ é®æŒ¡
2. **ä½ç½®è®¡ç®—ä¸æ­£ç¡®** - å·¥å…·æ¡ä½ç½®æ²¡æœ‰åŠ¨æ€è®¡ç®—ï¼Œä¸åœ¨ç”¨æˆ·å¯ç‚¹å‡»çš„ä½ç½®

### é—®é¢˜åŸå› åˆ†æ

#### åŸå› 1: DOMç»“æ„é—®é¢˜
```xml
<!-- ä¿®æ”¹å‰ -->
<view class="global-canvas-wrapper">
  <canvas></canvas>
  <view class="image-toolbar"></view>  <!-- åœ¨wrapperå†…éƒ¨ -->
</view>
```

**é—®é¢˜**:
- å·¥å…·æ¡åœ¨ `global-canvas-wrapper` å†…éƒ¨
- å½“ `workflowStep === 'selectLayout'` æ—¶ï¼Œwrapperè¢«ç§»åˆ°å±å¹•å¤–ï¼ˆ`left: -9999px`ï¼‰
- å·¥å…·æ¡ä¹Ÿè·Ÿç€è¢«ç§»åˆ°å±å¹•å¤–ï¼Œæ— æ³•æ˜¾ç¤º

#### åŸå› 2: å®šä½æ–¹å¼é—®é¢˜
```css
/* ä¿®æ”¹å‰ */
.image-toolbar {
  position: absolute;  /* ç›¸å¯¹äºwrapperå®šä½ */
}
```

**é—®é¢˜**:
- ä½¿ç”¨ `absolute` å®šä½ï¼Œç›¸å¯¹äº `global-canvas-wrapper`
- ä½†wrapperçš„ä½ç½®ä¼šåŠ¨æ€å˜åŒ–ï¼ˆæœ‰æ—¶åœ¨å±å¹•å¤–ï¼‰
- æ— æ³•ä¿è¯å·¥å…·æ¡å§‹ç»ˆåœ¨å¯è§åŒºåŸŸ

#### åŸå› 3: ä½ç½®è®¡ç®—é—®é¢˜
```javascript
// ä¿®æ”¹å‰
let toolbarX = pos.x + pos.width / 2;  // åªè€ƒè™‘canvaså†…çš„åæ ‡
let toolbarY = pos.y + pos.height + 10;
```

**é—®é¢˜**:
- åªè®¡ç®—äº†å›¾ç‰‡åœ¨canvasä¸­çš„ç›¸å¯¹ä½ç½®
- æ²¡æœ‰è€ƒè™‘canvasåœ¨é¡µé¢ä¸­çš„å®é™…ä½ç½®
- æ²¡æœ‰è€ƒè™‘é¡µé¢æ»šåŠ¨åç§»
- æ²¡æœ‰è€ƒè™‘è§†å£è¾¹ç•Œ

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: è°ƒæ•´DOMç»“æ„

**ä¿®æ”¹**: å°†å·¥å…·æ¡ç§»åˆ° `container` å±‚çº§

```xml
<!-- ä¿®æ”¹å -->
<view class="container">
  <view class="global-canvas-wrapper" id="canvas-wrapper">
    <canvas></canvas>
  </view>
  
  <!-- å·¥å…·æ¡ç§»åˆ°å¤–é¢ -->
  <view class="image-toolbar"></view>
</view>
```

**ä¼˜ç‚¹**:
- âœ… å·¥å…·æ¡ä¸å—wrapperä½ç½®å˜åŒ–å½±å“
- âœ… å§‹ç»ˆåœ¨DOMæ ‘çš„ç¨³å®šä½ç½®
- âœ… ä¸ä¼šè¢«ç§»åˆ°å±å¹•å¤–

### æ–¹æ¡ˆ2: æ”¹ç”¨fixedå®šä½

**ä¿®æ”¹**: ä½¿ç”¨ `position: fixed` ç›¸å¯¹äºè§†å£å®šä½

```css
/* ä¿®æ”¹å */
.image-toolbar {
  position: fixed;  /* ç›¸å¯¹äºè§†å£å®šä½ */
  z-index: 9999;    /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
}
```

**ä¼˜ç‚¹**:
- âœ… ç›¸å¯¹äºè§†å£å®šä½ï¼Œä¸å—çˆ¶å…ƒç´ å½±å“
- âœ… å§‹ç»ˆåœ¨å¯è§åŒºåŸŸ
- âœ… ä¸ä¼šè¢«å…¶ä»–å…ƒç´ é®æŒ¡

### æ–¹æ¡ˆ3: åŠ¨æ€è®¡ç®—ç»å¯¹ä½ç½®

**ä¿®æ”¹**: ä½¿ç”¨ `SelectorQuery` è·å–canvaså®é™…ä½ç½®

```javascript
// ä¿®æ”¹å
showImageToolbar(imageIndex, touchX, touchY) {
  // 1. è·å–canvasåœ¨é¡µé¢ä¸­çš„å®é™…ä½ç½®
  const query = wx.createSelectorQuery().in(this);
  query.select('#canvas-wrapper').boundingClientRect();
  query.selectViewport().scrollOffset();
  
  query.exec((res) => {
    const canvasRect = res[0]; // canvasä½ç½®ä¿¡æ¯
    
    // 2. è®¡ç®—å›¾ç‰‡åœ¨canvasä¸­çš„ä½ç½®
    const imageCenterX = pos.x + pos.width / 2;
    
    // 3. è®¡ç®—å·¥å…·æ¡åœ¨è§†å£ä¸­çš„ç»å¯¹ä½ç½®
    let toolbarX = canvasRect.left + imageCenterX;
    let toolbarY = canvasRect.top + pos.y + pos.height + 10;
    
    // 4. è¾¹ç•Œæ£€æŸ¥ï¼Œç¡®ä¿åœ¨è§†å£å†…
    const windowWidth = systemInfo.windowWidth;
    const windowHeight = systemInfo.windowHeight;
    
    // å·¦å³è¾¹ç•Œ
    if (toolbarX - toolbarWidth / 2 < 10) {
      toolbarX = toolbarWidth / 2 + 10;
    }
    if (toolbarX + toolbarWidth / 2 > windowWidth - 10) {
      toolbarX = windowWidth - toolbarWidth / 2 - 10;
    }
    
    // ä¸Šä¸‹è¾¹ç•Œ - æ™ºèƒ½è°ƒæ•´
    if (toolbarY + toolbarHeight > windowHeight - 10) {
      // ä¸‹æ–¹ç©ºé—´ä¸è¶³ï¼Œæ˜¾ç¤ºåœ¨ä¸Šæ–¹
      toolbarY = canvasRect.top + pos.y - toolbarHeight - 10;
      
      // ä¸Šæ–¹ä¹Ÿä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨ä¸­å¤®
      if (toolbarY < 10) {
        toolbarY = canvasRect.top + imageCenterY - toolbarHeight / 2;
      }
    }
  });
}
```

**ä¼˜ç‚¹**:
- âœ… ç²¾ç¡®è®¡ç®—canvasåœ¨é¡µé¢ä¸­çš„ä½ç½®
- âœ… è€ƒè™‘è§†å£å°ºå¯¸å’Œè¾¹ç•Œ
- âœ… æ™ºèƒ½è°ƒæ•´ä½ç½®ï¼ˆä¸‹æ–¹â†’ä¸Šæ–¹â†’ä¸­å¤®ï¼‰
- âœ… ç¡®ä¿å·¥å…·æ¡å§‹ç»ˆå¯è§å¯ç‚¹å‡»

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. pages/collage/collage.wxml

#### ä¿®æ”¹1: è°ƒæ•´DOMç»“æ„
```xml
<!-- ä¿®æ”¹å‰ -->
<view class="global-canvas-wrapper">
  <canvas></canvas>
  <view class="image-toolbar"></view>
</view>

<!-- ä¿®æ”¹å -->
<view class="container">
  <view class="global-canvas-wrapper" id="canvas-wrapper">
    <canvas></canvas>
  </view>
  <view class="image-toolbar"></view>
</view>
```

**å…³é”®ç‚¹**:
- ä¸º `global-canvas-wrapper` æ·»åŠ  `id="canvas-wrapper"`ï¼Œç”¨äºæŸ¥è¯¢ä½ç½®
- å°†å·¥å…·æ¡ç§»åˆ°wrapperå¤–éƒ¨

### 2. pages/collage/collage.wxss

#### ä¿®æ”¹1: æ”¹ç”¨fixedå®šä½
```css
/* ä¿®æ”¹å‰ */
.image-toolbar {
  position: absolute;
  z-index: 1000;
}

/* ä¿®æ”¹å */
.image-toolbar {
  position: fixed;  /* æ”¹ä¸ºfixed */
  z-index: 9999;    /* æé«˜å±‚çº§ */
}
```

### 3. pages/collage/collage.js

#### ä¿®æ”¹1: é‡å†™ä½ç½®è®¡ç®—é€»è¾‘

**ä½ç½®**: ç¬¬ 2528-2604 è¡Œ

**å…³é”®æ”¹åŠ¨**:
1. ä½¿ç”¨ `wx.createSelectorQuery()` è·å–canvasä½ç½®
2. ä½¿ç”¨ `wx.getSystemInfoSync()` è·å–çª—å£å°ºå¯¸
3. è®¡ç®—å·¥å…·æ¡åœ¨è§†å£ä¸­çš„ç»å¯¹ä½ç½®
4. æ™ºèƒ½è¾¹ç•Œæ£€æŸ¥å’Œä½ç½®è°ƒæ•´

## ğŸ¯ ä½ç½®è®¡ç®—é€»è¾‘è¯¦è§£

### åæ ‡ç³»ç»Ÿ

```
è§†å£åæ ‡ç³»ï¼ˆfixedå®šä½å‚è€ƒï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” (0, 0)
â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Canvas Wrapper  â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        â”‚
â”‚  â”‚  â”‚  å›¾ç‰‡åŒºåŸŸ  â”‚  â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚        â”‚
â”‚  â”‚                 â”‚        â”‚
â”‚  â”‚  [å·¥å…·æ¡]       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¡ç®—æ­¥éª¤

#### æ­¥éª¤1: è·å–canvasä½ç½®
```javascript
const query = wx.createSelectorQuery().in(this);
query.select('#canvas-wrapper').boundingClientRect();
query.exec((res) => {
  const canvasRect = res[0];
  // canvasRect.left - canvaså·¦è¾¹è·ç¦»è§†å£å·¦è¾¹çš„è·ç¦»
  // canvasRect.top - canvasé¡¶éƒ¨è·ç¦»è§†å£é¡¶éƒ¨çš„è·ç¦»
});
```

#### æ­¥éª¤2: è®¡ç®—å›¾ç‰‡ä¸­å¿ƒ
```javascript
const imageCenterX = pos.x + pos.width / 2;  // å›¾ç‰‡åœ¨canvasä¸­çš„ä¸­å¿ƒX
const imageCenterY = pos.y + pos.height / 2; // å›¾ç‰‡åœ¨canvasä¸­çš„ä¸­å¿ƒY
```

#### æ­¥éª¤3: è®¡ç®—å·¥å…·æ¡ä½ç½®
```javascript
// å·¥å…·æ¡X = canvaså·¦è¾¹è· + å›¾ç‰‡ä¸­å¿ƒX
let toolbarX = canvasRect.left + imageCenterX;

// å·¥å…·æ¡Y = canvasé¡¶éƒ¨è· + å›¾ç‰‡åº•éƒ¨ + é—´è·
let toolbarY = canvasRect.top + pos.y + pos.height + 10;
```

#### æ­¥éª¤4: è¾¹ç•Œæ£€æŸ¥
```javascript
// å·¦è¾¹ç•Œ
if (toolbarX - toolbarWidth / 2 < 10) {
  toolbarX = toolbarWidth / 2 + 10;
}

// å³è¾¹ç•Œ
if (toolbarX + toolbarWidth / 2 > windowWidth - 10) {
  toolbarX = windowWidth - toolbarWidth / 2 - 10;
}

// ä¸‹è¾¹ç•Œ - ä¼˜å…ˆæ˜¾ç¤ºåœ¨å›¾ç‰‡ä¸‹æ–¹
if (toolbarY + toolbarHeight > windowHeight - 10) {
  // å°è¯•æ˜¾ç¤ºåœ¨ä¸Šæ–¹
  toolbarY = canvasRect.top + pos.y - toolbarHeight - 10;
  
  // ä¸Šæ–¹ä¹Ÿä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨ä¸­å¤®
  if (toolbarY < 10) {
    toolbarY = canvasRect.top + imageCenterY - toolbarHeight / 2;
  }
}
```

### æ™ºèƒ½ä½ç½®è°ƒæ•´ç­–ç•¥

```
ä¼˜å…ˆçº§1: å›¾ç‰‡ä¸‹æ–¹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å›¾ç‰‡   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 [å·¥å…·æ¡]   â† é»˜è®¤ä½ç½®

ä¼˜å…ˆçº§2: å›¾ç‰‡ä¸Šæ–¹ï¼ˆä¸‹æ–¹ç©ºé—´ä¸è¶³ï¼‰
 [å·¥å…·æ¡]   â† å¤‡é€‰ä½ç½®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å›¾ç‰‡   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜å…ˆçº§3: å›¾ç‰‡ä¸­å¤®ï¼ˆä¸Šä¸‹éƒ½ä¸è¶³ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [å·¥å…·æ¡] â”‚ â† æœ€åé€‰æ‹©
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… éªŒè¯æ–¹æ³•

### æµ‹è¯•1: åŸºæœ¬æ˜¾ç¤º
1. è¿›å…¥å¸ƒå±€æ‹¼å›¾é¡µé¢
2. æ·»åŠ å›¾ç‰‡
3. ç‚¹å‡»å›¾ç‰‡
4. **é¢„æœŸ**: å·¥å…·æ¡æ­£ç¡®æ˜¾ç¤ºï¼Œä¸è¢«é®æŒ¡

### æµ‹è¯•2: ä¸åŒä½ç½®çš„å›¾ç‰‡
1. é€‰æ‹©å¤šå›¾å¸ƒå±€ï¼ˆå¦‚9å®«æ ¼ï¼‰
2. æ·»åŠ å›¾ç‰‡åˆ°ä¸åŒä½ç½®
3. ä¾æ¬¡ç‚¹å‡»ä¸åŒä½ç½®çš„å›¾ç‰‡
4. **é¢„æœŸ**: å·¥å…·æ¡å§‹ç»ˆåœ¨å¯è§åŒºåŸŸï¼Œä½ç½®åˆç†

### æµ‹è¯•3: è¾¹ç•Œæƒ…å†µ
1. ç‚¹å‡»é¡¶éƒ¨å›¾ç‰‡
2. **é¢„æœŸ**: å·¥å…·æ¡æ˜¾ç¤ºåœ¨å›¾ç‰‡ä¸‹æ–¹æˆ–ä¸­å¤®
3. ç‚¹å‡»åº•éƒ¨å›¾ç‰‡
4. **é¢„æœŸ**: å·¥å…·æ¡æ˜¾ç¤ºåœ¨å›¾ç‰‡ä¸Šæ–¹

### æµ‹è¯•4: é¡µé¢æ»šåŠ¨
1. é€‰æ‹©é•¿å›¾æ‹¼æ¥æˆ–å¤šå›¾å¸ƒå±€
2. æ»šåŠ¨é¡µé¢
3. ç‚¹å‡»ä¸åŒä½ç½®çš„å›¾ç‰‡
4. **é¢„æœŸ**: å·¥å…·æ¡ä½ç½®æ­£ç¡®ï¼Œè·Ÿéšå›¾ç‰‡

### æµ‹è¯•5: ä¸åŒå±å¹•å°ºå¯¸
1. åœ¨ä¸åŒè®¾å¤‡ä¸Šæµ‹è¯•
2. **é¢„æœŸ**: å·¥å…·æ¡åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šéƒ½èƒ½æ­£ç¡®æ˜¾ç¤º

## ğŸ“Š æŠ€æœ¯è¦ç‚¹

### 1. SelectorQuery API
```javascript
wx.createSelectorQuery()
  .in(this)                    // åœ¨å½“å‰é¡µé¢ä¸Šä¸‹æ–‡
  .select('#canvas-wrapper')   // é€‰æ‹©å…ƒç´ 
  .boundingClientRect()        // è·å–ä½ç½®ä¿¡æ¯
  .exec(callback)              // æ‰§è¡ŒæŸ¥è¯¢
```

### 2. ä½ç½®ä¿¡æ¯
```javascript
boundingClientRect() è¿”å›:
{
  left: number,    // å·¦è¾¹è·ç¦»è§†å£å·¦è¾¹çš„è·ç¦»
  top: number,     // é¡¶éƒ¨è·ç¦»è§†å£é¡¶éƒ¨çš„è·ç¦»
  right: number,   // å³è¾¹è·ç¦»è§†å£å·¦è¾¹çš„è·ç¦»
  bottom: number,  // åº•éƒ¨è·ç¦»è§†å£é¡¶éƒ¨çš„è·ç¦»
  width: number,   // å…ƒç´ å®½åº¦
  height: number   // å…ƒç´ é«˜åº¦
}
```

### 3. ç³»ç»Ÿä¿¡æ¯
```javascript
wx.getSystemInfoSync() è¿”å›:
{
  windowWidth: number,   // å¯ä½¿ç”¨çª—å£å®½åº¦
  windowHeight: number,  // å¯ä½¿ç”¨çª—å£é«˜åº¦
  screenWidth: number,   // å±å¹•å®½åº¦
  screenHeight: number,  // å±å¹•é«˜åº¦
  ...
}
```

### 4. å®šä½æ¨¡å¼å¯¹æ¯”

| å®šä½æ–¹å¼ | å‚è€ƒç‚¹ | é€‚ç”¨åœºæ™¯ | ä¼˜ç¼ºç‚¹ |
|---------|--------|---------|--------|
| static | æ­£å¸¸æµ | é»˜è®¤ | æ— æ³•ç²¾ç¡®å®šä½ |
| relative | è‡ªèº« | å¾®è°ƒä½ç½® | å æ®åŸå§‹ç©ºé—´ |
| absolute | å®šä½ç¥–å…ˆ | ç›¸å¯¹çˆ¶å…ƒç´  | å—çˆ¶å…ƒç´ å½±å“ |
| fixed | è§†å£ | æµ®åŠ¨å…ƒç´  | âœ… ä¸å—æ»šåŠ¨å½±å“ |
| sticky | æ··åˆ | å¸é¡¶æ•ˆæœ | å…¼å®¹æ€§é—®é¢˜ |

## ğŸ” æ³¨æ„äº‹é¡¹

1. **å¼‚æ­¥æŸ¥è¯¢**
   - `SelectorQuery.exec()` æ˜¯å¼‚æ­¥çš„
   - éœ€è¦åœ¨å›è°ƒä¸­è®¾ç½®ä½ç½®

2. **æ€§èƒ½è€ƒè™‘**
   - æ¯æ¬¡æ˜¾ç¤ºå·¥å…·æ¡éƒ½ä¼šæŸ¥è¯¢DOM
   - æŸ¥è¯¢æ“ä½œè¾ƒå¿«ï¼Œä¸å½±å“æ€§èƒ½

3. **è¾¹ç•Œå®‰å…¨è·ç¦»**
   - è®¾ç½®10pxçš„å®‰å…¨è¾¹è·
   - é˜²æ­¢å·¥å…·æ¡ç´§è´´è¾¹ç¼˜

4. **å·¥å…·æ¡å°ºå¯¸**
   - é¢„ä¼°å®½åº¦280pxï¼Œé«˜åº¦60px
   - å®é™…å°ºå¯¸å¯èƒ½ç•¥æœ‰ä¸åŒ

## ğŸ“ æ€»ç»“

é€šè¿‡ä¸‰ä¸ªå…³é”®ä¿®æ”¹ï¼š
1. âœ… **è°ƒæ•´DOMç»“æ„** - å·¥å…·æ¡ç§»åˆ°containerå±‚çº§
2. âœ… **æ”¹ç”¨fixedå®šä½** - ç›¸å¯¹äºè§†å£å®šä½
3. âœ… **åŠ¨æ€è®¡ç®—ä½ç½®** - ç²¾ç¡®è®¡ç®—å¹¶æ™ºèƒ½è°ƒæ•´

æˆåŠŸè§£å†³äº†ï¼š
- âœ… å·¥å…·æ¡è¢«é®æŒ¡çš„é—®é¢˜
- âœ… ä½ç½®è®¡ç®—ä¸å‡†ç¡®çš„é—®é¢˜
- âœ… å·¥å…·æ¡ä¸åœ¨å¯ç‚¹å‡»ä½ç½®çš„é—®é¢˜

ç°åœ¨å·¥å…·æ¡èƒ½å¤Ÿï¼š
- âœ… å§‹ç»ˆæ˜¾ç¤ºåœ¨å¯è§åŒºåŸŸ
- âœ… æ™ºèƒ½è°ƒæ•´ä½ç½®ï¼ˆä¸‹æ–¹â†’ä¸Šæ–¹â†’ä¸­å¤®ï¼‰
- âœ… é€‚é…ä¸åŒå±å¹•å°ºå¯¸
- âœ… æ­£ç¡®å¤„ç†é¡µé¢æ»šåŠ¨

---

**ä¿®å¤æ—¥æœŸ**: 2025-11-05  
**ä¿®å¤ç‰ˆæœ¬**: v1.0.2  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

