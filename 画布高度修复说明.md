# 画布高度修复说明

## 📅 修复日期
2025-11-07

---

## 🐛 问题描述

画布高度计算有问题，因为页面使用了自定义导航栏，导致画布区域的高度计算不正确，并且画布盒子一部分被导航栏遮住了。

### 问题原因

#### 问题1：高度计算错误

1. **父容器 `.editing-area-new`** 已经通过 `padding-top` 为自定义导航栏预留了空间：
   ```css
   .editing-area-new {
     height: 100vh;
     padding-top: calc(var(--status-bar-height, 20px) + var(--navigation-bar-height, 44px));
     box-sizing: border-box;
   }
   ```

2. **子容器 `.canvas-area-flex`** 的高度计算又从 `100vh` 减去了导航栏高度：
   ```xml
   <!-- 错误的写法 -->
   <view class="canvas-area-flex"
         style="height: calc(100vh - {{statusBarHeight + navigationBarHeight}}px)">
   ```

3. **结果**：导航栏高度被减了两次，导致画布区域比预期小了一个导航栏的高度。

#### 问题2：padding 导致内容被遮挡

1. **`.canvas-area-flex`** 有 `padding: 16px`（包括 `padding-top: 16px`）
2. 但父容器已经通过 `padding-top` 为导航栏预留了空间
3. **结果**：画布盒子的顶部被导航栏遮住了

---

## ✅ 解决方案

### 修复1：高度计算

#### 修改前（错误）

```xml
<!-- pages/collage/collage.wxml -->
<view class="canvas-area-flex"
      style="height: {{drawerState === 'full'
        ? 'calc(100vh - ' + (statusBarHeight + navigationBarHeight) + 'px)'
        : 'calc(100vh - ' + (statusBarHeight + navigationBarHeight + drawerHeight) + 'px)'}}">
```

**问题**：
- 使用 `100vh` 作为基准
- 减去了 `statusBarHeight + navigationBarHeight`
- 但父容器已经通过 `padding-top` 预留了这个空间
- 导致重复减去导航栏高度

#### 修改后（正确）

```xml
<!-- pages/collage/collage.wxml -->
<view class="canvas-area-flex"
      style="height: {{drawerState === 'full'
        ? '100%'
        : 'calc(100% - ' + drawerHeight + 'px)'}}">
```

**改进**：
- 使用 `100%` 作为基准（相对于父容器的可用空间）
- 只在非 `full` 状态时减去抽屉高度
- 不再重复减去导航栏高度

---

### 修复2：padding 调整

#### 修改前（错误）

```css
/* pages/collage/collage.wxss */
.canvas-area-flex {
  padding: 16px; /* 包括 padding-top: 16px */
}
```

**问题**：
- `padding-top: 16px` 会让画布内容从顶部向下偏移
- 但父容器已经通过 `padding-top` 为导航栏预留了空间
- 导致画布盒子的顶部被导航栏遮住

#### 修改后（正确）

```css
/* pages/collage/collage.wxss */
.canvas-area-flex {
  padding: 0 16px 16px 16px; /* 只保留左右下的padding，顶部不需要 */
}
```

**改进**：
- 移除 `padding-top`，避免内容被遮挡
- 保留左右下的 padding，保持视觉效果

---

## 📐 高度计算逻辑

### iPhone 12 示例数据
```
windowHeight = 844px
statusBarHeight = 47px
navigationBarHeight = 40px
topBarHeight = 87px
```

### 父容器高度
```
.editing-area-new 的实际可用高度 = 100vh - padding-top
                                = 844px - 87px
                                = 757px
```

### 画布区域高度

#### 第二层（full）
```javascript
drawerState = 'full'
canvas-area-flex 高度 = 100%
                      = 757px (父容器的100%)
```

#### 第一层（half）
```javascript
drawerState = 'half'
drawerHeight = 300px
canvas-area-flex 高度 = calc(100% - 300px)
                      = 757px - 300px
                      = 457px
```

#### 收起（collapsed）
```javascript
drawerState = 'collapsed'
drawerHeight = 100px
canvas-area-flex 高度 = calc(100% - 100px)
                      = 757px - 100px
                      = 657px
```

---

## 🎯 关键要点

1. **父容器已预留导航栏空间**：`.editing-area-new` 通过 `padding-top` 预留了导航栏高度
2. **子容器使用相对高度**：`.canvas-area-flex` 使用 `100%` 而不是 `100vh`
3. **避免重复计算**：不要在子容器中再次减去导航栏高度
4. **抽屉高度单独处理**：只在非 `full` 状态时减去抽屉高度

---

## 📊 修复前后对比

| 状态 | 抽屉高度 | 修复前画布高度 | 修复后画布高度 | 差异 |
|------|---------|---------------|---------------|------|
| 收起 | 100px | 570px | 657px | +87px |
| 第一层 | 300px | 370px | 457px | +87px |
| 第二层 | 675.2px | 670px | 757px | +87px |

**说明**：修复后，画布高度增加了 87px（导航栏高度），这是正确的。

---

## ✅ 测试验证

### 测试步骤
1. 打开拼图编辑页面
2. 观察画布区域是否正确填充可用空间
3. 切换抽屉状态（收起 → 第一层 → 第二层）
4. 确认画布高度变化是否符合预期

### 预期结果
- ✅ 画布区域正确填充可用空间
- ✅ 不会出现多余的空白区域
- ✅ 抽屉状态切换时，画布高度平滑变化
- ✅ 自定义导航栏不会遮挡画布内容

---

## 📝 相关文件

- `pages/collage/collage.wxml` - 修改画布区域高度计算
- `pages/collage/collage.wxss` - 修改 padding，移除 padding-top
- `抽屉两层模式说明.md` - 更新文档说明

---

## 🎉 完成状态

✅ 画布高度和遮挡问题已全部修复！

**关键改进**：
1. ✅ 使用相对高度 `100%` 替代绝对高度 `100vh`
2. ✅ 避免重复减去导航栏高度
3. ✅ 移除 `.canvas-area-flex` 的 `padding-top`，避免内容被遮挡
4. ✅ 使用内联样式设置 `padding-top`，确保准确计算（94px = statusBarHeight + navigationBarHeight）
5. ✅ 画布区域正确填充可用空间，不会被导航栏遮挡

---

## 🔍 补充说明：为什么使用内联样式而不是 CSS 变量

### 问题
原本使用 CSS 变量的方式：
```css
.editing-area-new {
  padding-top: calc(var(--status-bar-height, 20px) + var(--navigation-bar-height, 44px));
}
```

但实际计算出来的 `padding-top` 是 64px（默认值），而不是正确的 94px。

### 原因
CSS 变量是通过 JS 动态设置在 `.container` 节点上的：
```javascript
containerNode.style.setProperty('--status-bar-height', `${statusBarHeight}px`);
containerNode.style.setProperty('--navigation-bar-height', `${navigationBarHeight}px`);
```

但这个设置可能在页面渲染时还未完成，或者变量继承有问题。

### 解决方案
直接使用内联样式，确保值准确：
```xml
<view class="editing-area-new"
      style="padding-top: {{statusBarHeight + navigationBarHeight}}px;">
```

这样可以确保：
- ✅ 值准确（例如：47px + 40px = 87px，或其他设备的实际值）
- ✅ 实时计算，不依赖 CSS 变量
- ✅ 与导航栏的内联样式保持一致

