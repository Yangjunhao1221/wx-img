<!--pages/history/history.wxml-->
<view class="container">
  <!-- å¤´éƒ¨æ“ä½œæ  -->
  <view class="header" wx:if="{{!isEmpty}}">
    <view class="header-left">
      <text class="page-title">ğŸ“š å†å²è®°å½•</text>
      <text class="items-count">å…± {{historyList.length}} é¡¹</text>
    </view>
    
    <view class="header-actions">
      <button 
        class="btn btn-outline btn-sm" 
        bindtap="toggleEditMode"
      >
        {{isEditing ? 'å®Œæˆ' : 'ç¼–è¾‘'}}
      </button>
      
      <button 
        class="btn btn-danger btn-sm" 
        bindtap="clearAllHistory"
        wx:if="{{!isEditing}}"
      >
        ğŸ—‘ï¸ æ¸…ç©º
      </button>
    </view>
  </view>

  <!-- ç¼–è¾‘æ¨¡å¼æ“ä½œæ  -->
  <view class="edit-actions" wx:if="{{isEditing && !isEmpty}}">
    <view class="edit-left">
      <button 
        class="btn btn-outline btn-sm" 
        bindtap="toggleSelectAll"
      >
        {{selectedItems.length === historyList.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}
      </button>
      <text class="selected-count">å·²é€‰æ‹© {{selectedItems.length}} é¡¹</text>
    </view>
    
    <view class="edit-right">
      <button 
        class="btn btn-primary btn-sm" 
        bindtap="downloadSelected"
        disabled="{{selectedItems.length === 0}}"
      >
        ğŸ“¥ ä¸‹è½½
      </button>
      <button 
        class="btn btn-danger btn-sm" 
        bindtap="deleteSelected"
        disabled="{{selectedItems.length === 0}}"
      >
        åˆ é™¤
      </button>
    </view>
  </view>

  <!-- å†å²è®°å½•åˆ—è¡¨ -->
  <view class="history-list" wx:if="{{!isEmpty}}">
    <view 
      class="history-item {{isEditing ? 'editing' : ''}}" 
      wx:for="{{historyList}}" 
      wx:key="id"
      data-index="{{index}}"
      bindtap="{{isEditing ? 'onItemSelect' : 'previewImage'}}"
    >
      <!-- é€‰æ‹©æ¡† -->
      <view class="item-selector" wx:if="{{isEditing}}">
        <view class="checkbox {{selectedItems.includes(index) ? 'checked' : ''}}">
          <text class="checkmark" wx:if="{{selectedItems.includes(index)}}">âœ“</text>
        </view>
      </view>

      <!-- é¢„è§ˆå›¾ -->
      <view class="item-image">
        <image 
          src="{{item.imagePath}}" 
          mode="aspectFill"
          class="preview-image"
        />
        <view class="image-overlay">
          <text class="image-type">{{item.type === 'collage' ? 'å¸ƒå±€æ‹¼å›¾' : 'é•¿å›¾æ‹¼æ¥'}}</text>
        </view>
      </view>

      <!-- é¡¹ç›®ä¿¡æ¯ -->
      <view class="item-info">
        <view class="item-title">{{item.title || 'æœªå‘½åæ‹¼å›¾'}}</view>
        <view class="item-details">
          <text class="item-time">{{formatTime(item.timestamp)}}</text>
          <text class="item-count">{{item.imageCount}} å¼ å›¾ç‰‡</text>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="item-actions" wx:if="{{!isEditing}}">
        <button 
          class="action-btn" 
          data-index="{{index}}"
          bindtap="downloadImage"
          catchtap="true"
        >
          ğŸ“¥
        </button>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{isEmpty}}">
    <view class="empty-icon">ğŸ“š</view>
    <text class="empty-title">æš‚æ— å†å²è®°å½•</text>
    <text class="empty-desc">å¼€å§‹åˆ¶ä½œä½ çš„ç¬¬ä¸€å¼ æ‹¼å›¾å§</text>
    
    <view class="empty-actions">
      <button class="btn btn-primary" bindtap="goToCollage">
        ğŸ§© å¸ƒå±€æ‹¼å›¾
      </button>
      <button class="btn btn-secondary" bindtap="goToLongImage">
        ğŸ“ é•¿å›¾æ‹¼æ¥
      </button>
    </view>
  </view>
</view>

<wxs module="utils">
  var formatTime = function(timestamp) {
    var date = getDate(timestamp);
    var now = getDate();
    var diff = now.getTime() - date.getTime();
    
    if (diff < 60000) {
      return 'åˆšåˆš';
    } else if (diff < 3600000) {
      return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
    } else if (diff < 86400000) {
      return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
    } else if (diff < 604800000) {
      return Math.floor(diff / 86400000) + 'å¤©å‰';
    } else {
      return date.toLocaleDateString();
    }
  };

  module.exports.formatTime = formatTime;
</wxs>
