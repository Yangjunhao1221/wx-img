<!--pages/collage/collage.wxml-->
<view class="container">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <view class="custom-navigation-bar" style="padding-top: {{statusBarHeight}}px;">
    <!-- å¯¼èˆªæ å†…å®¹ -->
    <view class="navigation-bar-content" style="height: {{navigationBarHeight}}px;">
      <!-- å·¦ä¾§æŒ‰é’®ç»„ -->
      <view class="nav-left">
        <!-- è¿”å›æŒ‰é’® -->
        <view class="nav-back" bindtap="onNavBack">
          <text class="nav-back-icon">â€¹</text>
        </view>

        <!-- ä¿å­˜æŒ‰é’® -->
        <view class="nav-save" wx:if="{{selectedImages.length > 0}}" bindtap="exportImage">
          <text class="nav-save-text">ä¿å­˜</text>
        </view>
      </view>

      <!-- é¡µé¢æ ‡é¢˜ -->
      <view class="nav-title">
        <text class="nav-title-text">æ‹¼å›¾ç¼–è¾‘</text>
      </view>

      <!-- å³ä¾§å ä½,ä¿æŒå¸ƒå±€å¹³è¡¡ -->
      <view class="nav-right"></view>
    </view>
  </view>

  <!-- æ­¥éª¤1: é€‰æ‹©å¸ƒå±€æ¨¡æ¿ -->
  <view class="layout-selection-area" wx:if="{{workflowStep === 'selectLayout'}}">
    <view class="step-header">
      <text class="step-title">ğŸ“ é€‰æ‹©å¸ƒå±€æ¨¡æ¿</text>
      <text class="step-desc">æ”¯æŒ1-16å¼ å›¾ç‰‡,å…±{{allLayoutTemplates.length}}ç§å¸ƒå±€</text>
    </view>

    <!-- å›¾ç‰‡æ•°é‡åˆ†ç±»æ ‡ç­¾ -->
    <scroll-view class="image-count-tabs" scroll-x>
      <view class="tabs-container">
        <view
          class="tab-item {{selectedImageCount === 0 ? 'active' : ''}}"
          data-count="{{0}}"
          bindtap="onImageCountSelect"
        >
          <text class="tab-label">å…¨éƒ¨</text>
        </view>
        <view
          class="tab-item {{selectedImageCount === item.imageCount ? 'active' : ''}}"
          wx:for="{{layoutGroups}}"
          wx:key="imageCount"
          data-count="{{item.imageCount}}"
          bindtap="onImageCountSelect"
        >
          <text class="tab-label">{{item.label}}</text>
          <text class="tab-count">{{item.count}}</text>
        </view>
      </view>
    </scroll-view>

    <!-- å¸ƒå±€æ¨¡æ¿ç½‘æ ¼ -->
    <scroll-view class="layout-templates-scroll" scroll-y>
      <view class="layout-templates-grid">
        <view
          class="layout-template-card {{selectedLayout === index ? 'selected' : ''}}"
          wx:for="{{selectedImageCount === 0 ? allLayoutTemplates : layoutGroups[selectedImageCount - 1].templates}}"
          wx:key="index"
          data-index="{{index}}"
          data-template="{{item}}"
          bindtap="onLayoutSelect"
        >
          <!-- å¯è§†åŒ–å¸ƒå±€é¢„è§ˆ -->
          <view class="template-preview-visual">
            <!-- ç½‘æ ¼å¸ƒå±€é¢„è§ˆ -->
            <view wx:if="{{item.type === 'grid'}}" class="grid-preview" style="grid-template-rows: repeat({{item.rows}}, 1fr); grid-template-columns: repeat({{item.cols}}, 1fr);">
              <view
                class="grid-cell"
                wx:for="{{item.imageCount}}"
                wx:for-item="cellIndex"
                wx:key="cellIndex"
              ></view>
            </view>

            <!-- è‡ªå®šä¹‰å¸ƒå±€é¢„è§ˆ -->
            <view wx:else class="custom-preview">
              <view
                class="custom-cell"
                wx:for="{{item.positions}}"
                wx:for-item="pos"
                wx:key="index"
                style="left: {{pos.x * 100}}%; top: {{pos.y * 100}}%; width: {{pos.width * 100}}%; height: {{pos.height * 100}}%;"
              ></view>
            </view>
          </view>
          <view class="template-info">
            <text class="template-name">{{item.name}}</text>
            <text class="template-count">{{item.imageCount}}å¼ </text>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ­¥éª¤2/3: æ·»åŠ å›¾ç‰‡ / ç¼–è¾‘ - æ–°å¸ƒå±€ -->
  <view class="editing-area-new" wx:if="{{workflowStep === 'addImages' || workflowStep === 'editing'}}" bindtap="onPageTap">

    <!-- ç”»å¸ƒåŒºåŸŸ - æ ¹æ®æŠ½å±‰çŠ¶æ€åŠ¨æ€è°ƒæ•´é«˜åº¦ -->
    <view class="canvas-area-flex" style="height: {{drawerState === 'full' ? 'calc(100vh - ' + (statusBarHeight + navigationBarHeight) + 'px)' : 'calc(100vh - ' + (statusBarHeight + navigationBarHeight + drawerHeight) + 'px)'}}">
      <!-- Loading é®ç½© -->
      <view class="loading-overlay" wx:if="{{isLoading}}">
        <view class="loading-spinner"></view>
        <text class="loading-text">{{loadingText}}</text>
      </view>

      <!-- Canvas å…ƒç´  -->
      <view class="canvas-wrapper-editing" id="canvas-wrapper" catchtap="stopPropagation">
        <canvas
          type="2d"
          id="canvas"
          class="canvas"
          style="width: {{canvasWidth}}px; height: {{canvasHeight}}px; display: block;"
          bindtouchstart="onCanvasTouchStart"
          bindtouchmove="onCanvasTouchMove"
          bindtouchend="onCanvasTouchEnd">
        </canvas>
      </view>

    </view>

    <!-- æ”¶èµ·æŒ‰é’® - å®šä½åœ¨æŠ½å±‰å¤–çš„å³ä¸Šè§’ -->
    <view class="collapse-button-outside" wx:if="{{showCollapseButton}}" bindtap="collapseDrawer" style="bottom: {{drawerHeight + 8}}px;">
      <text class="collapse-icon">â–¼</text>
    </view>

    <!-- åº•éƒ¨æŠ½å±‰åŒºåŸŸ - åŠ¨æ€é«˜åº¦ -->
    <view class="bottom-drawer-area" style="height: {{drawerHeight}}px;">
      <!-- æŠ½å±‰å¤´éƒ¨ï¼šæ‹–åŠ¨æ‰‹æŸ„ + Tabå¯¼èˆªæ  -->
      <view class="drawer-header"
            bindtouchstart="onDrawerTouchStart"
            catchtouchmove="onDrawerTouchMove"
            bindtouchend="onDrawerTouchEnd">
        <!-- æ‹–åŠ¨æ‰‹æŸ„ -->
        <view class="drawer-handle"></view>

        <!-- Tab å¯¼èˆªæ  -->
        <view class="tab-bar-minimal">
          <view
            wx:for="{{tabs}}"
            wx:key="id"
            class="tab-item-minimal {{currentTab === item.id ? 'active' : ''}}"
            data-tab-id="{{item.id}}"
            bindtap="onTabChange"
          >
            <text class="tab-label">{{item.name}}</text>
          </view>
        </view>
      </view>

      <!-- Tab å†…å®¹åŒºï¼ˆå¯æ»šåŠ¨ï¼‰ -->
      <scroll-view class="tab-content"
                   scroll-y
                   enhanced
                   show-scrollbar="{{false}}"
                   bindscrolltoupper="onContentScrollToUpper"
                   bindtouchstart="onContentTouchStart"
                   bindtouchmove="onContentTouchMove"
                   bindtouchend="onContentTouchEnd">

        <!-- Tab 1: æµ·æŠ¥ -->
        <view wx:if="{{currentTab === 'poster'}}" class="tab-panel">
          <view class="placeholder-content">
            <text class="placeholder-text">æµ·æŠ¥æ¨¡ç‰ˆï¼ˆå¾…æ¥å…¥æ•°æ®ï¼‰</text>
          </view>
        </view>

        <!-- Tab 2: æ¨¡ç‰ˆ -->
        <view wx:if="{{currentTab === 'template'}}" class="tab-panel">
          <!-- ç”»å¸ƒæ¯”ä¾‹ -->
          <view class="section-title-small">ç”»å¸ƒæ¯”ä¾‹</view>
          <scroll-view class="ratio-scroll-horizontal" scroll-x enhanced show-scrollbar="{{false}}">
            <view class="ratio-chips">
              <view
                class="ratio-chip {{aspectRatio === item.value ? 'active' : ''}}"
                wx:for="{{aspectRatios}}"
                wx:key="value"
                data-ratio="{{item.value}}"
                bindtap="onAspectRatioChange"
              >
                <text class="ratio-label">{{item.label}}</text>
              </view>
            </view>
          </scroll-view>

          <!-- æ¨èå¸ƒå±€ -->
          <view class="section-title-small">æ¨èå¸ƒå±€</view>
          <scroll-view class="template-scroll-horizontal" scroll-x enhanced show-scrollbar="{{false}}" wx:if="{{inlineTemplates && inlineTemplates.length}}">
            <view class="template-chips">
              <view
                class="template-chip {{currentLayoutTemplate && currentLayoutTemplate.name === item.name ? 'active' : ''}}"
                wx:for="{{inlineTemplates}}"
                wx:key="index"
                data-index="{{index}}"
                bindtap="onInlineTemplateSelect"
              >
                <view class="template-preview">
                  <block wx:for="{{item.previewBlocks}}" wx:for-item="b" wx:key="*this">
                    <view class="template-block" style="left: {{b.left}}%; top: {{b.top}}%; width: {{b.width}}%; height: {{b.height}}%;"></view>
                  </block>
                </view>
              </view>
            </view>
          </scroll-view>
        </view>

        <!-- Tab 3: æ‹¼æ¥ -->
        <view wx:if="{{currentTab === 'splice'}}" class="tab-panel">
          <view class="placeholder-content">
            <text class="placeholder-text">æ‹¼æ¥æ¨¡å¼ï¼ˆå¾…æ¥å…¥æ•°æ®ï¼‰</text>
          </view>
        </view>

        <!-- Tab 4: è‡ªç”± -->
        <view wx:if="{{currentTab === 'free'}}" class="tab-panel">
          <view class="placeholder-content">
            <text class="placeholder-text">è‡ªç”±æ¨¡å¼ï¼ˆå¾…æ¥å…¥æ•°æ®ï¼‰</text>
          </view>
        </view>

        <!-- Tab 5: è®¾ç½® -->
        <view wx:if="{{currentTab === 'settings'}}" class="tab-panel">
          <!-- æ ·å¼è®¾ç½® -->
          <view class="style-controls-compact">
            <!-- å›¾ç‰‡æ˜¾ç¤ºæ¨¡å¼ -->
            <view class="control-row">
              <text class="control-label">å›¾ç‰‡æ˜¾ç¤º</text>
              <view class="control-switch-wrapper">
                <text class="switch-label">{{imageFitMode === 'cover' ? 'å¡«æ»¡' : 'å®Œå…¨æ˜¾ç¤º'}}</text>
                <switch checked="{{imageFitMode === 'cover'}}" bindchange="toggleImageFitMode" color="#07c160"/>
              </view>
            </view>

            <!-- é—´è· -->
            <view class="control-row">
              <text class="control-label">é—´è·</text>
              <slider class="control-slider" value="{{spacing}}" min="0" max="50" bindchange="onSpacingChange"/>
              <text class="control-value">{{spacing}}</text>
            </view>

            <!-- åœ†è§’ -->
            <view class="control-row">
              <text class="control-label">åœ†è§’</text>
              <slider class="control-slider" value="{{cornerRadius}}" min="0" max="50" bindchange="onCornerRadiusChange"/>
              <text class="control-value">{{cornerRadius}}</text>
            </view>

            <!-- èƒŒæ™¯è‰² -->
            <view class="control-row">
              <text class="control-label">èƒŒæ™¯</text>
              <input class="color-picker" type="color" value="{{backgroundColor}}" bindchange="onBackgroundColorChange"/>
            </view>
          </view>
        </view>

      </scroll-view>
    </view>

    <!-- æ‚¬æµ®æ·»åŠ å›¾ç‰‡æŒ‰é’® - åŠ¨æ€ä½ç½® -->
    <view class="fab-add-image" style="bottom: {{drawerHeight + 20}}px;" bindtap="selectImages">
      <text class="fab-icon">+</text>
    </view>

    <!-- å›¾ç‰‡æ“ä½œå·¥å…·æ¡ - ä½¿ç”¨ cover-view è¦†ç›–åœ¨ Canvas ä¸Š -->
    <cover-view class="image-toolbar" wx:if="{{showImageToolbar}}" style="left: {{toolbarPosition.x}}px; top: {{toolbarPosition.y}}px;">
      <cover-view class="toolbar-container">
        <cover-view class="toolbar-item" bindtap="onToolbarReplace">
          <cover-view class="toolbar-icon">ğŸ–¼ï¸</cover-view>
          <cover-view class="toolbar-label">æ¢ä¸€å¼ </cover-view>
        </cover-view>
        <cover-view class="toolbar-item" bindtap="onToolbarRotate">
          <cover-view class="toolbar-icon">ğŸ”„</cover-view>
          <cover-view class="toolbar-label">æ—‹è½¬</cover-view>
        </cover-view>
        <cover-view class="toolbar-item" bindtap="onToolbarZoomIn">
          <cover-view class="toolbar-icon">â•</cover-view>
          <cover-view class="toolbar-label">æ”¾å¤§</cover-view>
        </cover-view>
        <cover-view class="toolbar-item" bindtap="onToolbarZoomOut">
          <cover-view class="toolbar-icon">â–</cover-view>
          <cover-view class="toolbar-label">ç¼©å°</cover-view>
        </cover-view>
        <cover-view class="toolbar-item" bindtap="onToolbarDelete">
          <cover-view class="toolbar-icon">ğŸ—‘ï¸</cover-view>
          <cover-view class="toolbar-label">åˆ é™¤</cover-view>
        </cover-view>
      </cover-view>
    </cover-view>
  </view>
</view>