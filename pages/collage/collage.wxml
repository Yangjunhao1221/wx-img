<!--pages/collage/collage.wxml-->
<view class="container">
  <!-- Canvaså…ƒç´  - å§‹ç»ˆå­˜åœ¨,æ ¹æ®æ­¥éª¤æ”¹å˜æ ·å¼ -->
  <view class="global-canvas-wrapper" style="{{workflowStep === 'selectLayout' ? 'position: fixed; left: -9999px; top: -9999px; width: ' + canvasWidth + 'px; height: ' + canvasHeight + 'px;' : 'width: ' + canvasWidth + 'px; height: ' + canvasHeight + 'px; margin: 20rpx auto;'}}">
    <canvas
      type="2d"
      id="canvas"
      class="canvas"
      style="width: {{canvasWidth}}px; height: {{canvasHeight}}px; display: block;"
      bindtouchstart="{{workflowStep !== 'selectLayout' ? 'onCanvasTouchStart' : ''}}"
      bindtouchmove="{{workflowStep !== 'selectLayout' ? 'onCanvasTouchMove' : ''}}"
      bindtouchend="{{workflowStep !== 'selectLayout' ? 'onCanvasTouchEnd' : ''}}">
    </canvas>
  </view>

  <!-- æ­¥éª¤1: é€‰æ‹©å¸ƒå±€æ¨¡æ¿ -->
  <view class="layout-selection-area" wx:if="{{workflowStep === 'selectLayout'}}">
    <view class="step-header">
      <text class="step-title">ğŸ“ é€‰æ‹©å¸ƒå±€æ¨¡æ¿</text>
      <text class="step-desc">æ”¯æŒ1-16å¼ å›¾ç‰‡,å…±{{allLayoutTemplates.length}}ç§å¸ƒå±€</text>
    </view>

    <!-- å›¾ç‰‡æ•°é‡åˆ†ç±»æ ‡ç­¾ -->
    <scroll-view class="image-count-tabs" scroll-x>
      <view class="tabs-container">
        <view
          class="tab-item {{selectedImageCount === 0 ? 'active' : ''}}"
          data-count="{{0}}"
          bindtap="onImageCountSelect"
        >
          <text class="tab-label">å…¨éƒ¨</text>
        </view>
        <view
          class="tab-item {{selectedImageCount === item.imageCount ? 'active' : ''}}"
          wx:for="{{layoutGroups}}"
          wx:key="imageCount"
          data-count="{{item.imageCount}}"
          bindtap="onImageCountSelect"
        >
          <text class="tab-label">{{item.label}}</text>
          <text class="tab-count">{{item.count}}</text>
        </view>
      </view>
    </scroll-view>

    <!-- å¸ƒå±€æ¨¡æ¿ç½‘æ ¼ -->
    <scroll-view class="layout-templates-scroll" scroll-y>
      <view class="layout-templates-grid">
        <view
          class="layout-template-card {{selectedLayout === index ? 'selected' : ''}}"
          wx:for="{{selectedImageCount === 0 ? allLayoutTemplates : layoutGroups[selectedImageCount - 1].templates}}"
          wx:key="index"
          data-index="{{index}}"
          bindtap="onLayoutSelect"
        >
          <view class="template-preview">
            <text class="template-icon">{{item.icon || 'â–¦'}}</text>
          </view>
          <view class="template-info">
            <text class="template-name">{{item.name}}</text>
            <text class="template-count">{{item.imageCount}}å¼ </text>
            <text class="template-type">{{item.type === 'grid' ? 'ç½‘æ ¼' : 'è‡ªå®šä¹‰'}}</text>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ­¥éª¤2/3: æ·»åŠ å›¾ç‰‡ / ç¼–è¾‘ -->
  <view class="editing-area" wx:if="{{workflowStep === 'addImages' || workflowStep === 'editing'}}">
    <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šCanvasé¢„è§ˆåŒºåŸŸ -->
    <view class="image-area">
      <!-- å¸ƒå±€ä¿¡æ¯æç¤º -->
      <view class="layout-info-bar" wx:if="{{currentLayoutTemplate}}">
        <text class="layout-info-text">{{currentLayoutTemplate.name}} ({{currentLayoutTemplate.imageCount}}å¼ )</text>
        <button class="btn-change-layout" bindtap="changeLayout">æ›´æ¢å¸ƒå±€</button>
      </view>
    </view>

    <!-- ä¸‹åŠéƒ¨åˆ†ï¼šæ§åˆ¶åŒºåŸŸ -->
    <view class="control-area">
      <!-- å›¾ç‰‡æ§½ä½ç®¡ç† -->
      <view class="control-section">
        <view class="section-header">
          <text class="section-title">å›¾ç‰‡ ({{selectedImages.length}}/{{currentLayoutTemplate.imageCount}})</text>
          <button class="btn-add" bindtap="selectImages">ä¸€é”®ä¸Šä¼ </button>
        </view>

        <!-- å›¾ç‰‡æ§½ä½åˆ—è¡¨ -->
        <scroll-view class="image-slots-scroll" scroll-x>
          <view class="image-slots">
            <view
              class="slot-item {{item.isEmpty ? 'empty' : 'filled'}}"
              wx:for="{{imageSlots}}"
              wx:key="index"
              data-index="{{index}}"
              bindtap="onSlotTap"
            >
              <!-- ç©ºæ§½ä½ -->
              <view class="slot-empty" wx:if="{{item.isEmpty}}">
                <text class="slot-plus">+</text>
                <text class="slot-number">{{index + 1}}</text>
              </view>

              <!-- å·²å¡«å……æ§½ä½ -->
              <view class="slot-filled" wx:else>
                <image src="{{item.image.path}}" mode="aspectFill" class="slot-image"/>
                <view class="slot-number-badge">{{index + 1}}</view>
                <view class="slot-remove" catchtap="onSlotRemove" data-index="{{index}}">Ã—</view>
              </view>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- æ ·å¼æ§åˆ¶ -->
      <view class="control-section">
      <view class="section-header">
        <text class="section-title">æ ·å¼</text>
      </view>
      
      <view class="style-controls">
        <!-- é—´è· -->
        <view class="control-item">
          <text class="control-label">é—´è·</text>
          <slider class="control-slider" value="{{spacing}}" min="0" max="50" bindchange="onSpacingChange"/>
          <text class="control-value">{{spacing}}</text>
        </view>
        
        <!-- åœ†è§’ -->
        <view class="control-item">
          <text class="control-label">åœ†è§’</text>
          <slider class="control-slider" value="{{cornerRadius}}" min="0" max="50" bindchange="onCornerRadiusChange"/>
          <text class="control-value">{{cornerRadius}}</text>
        </view>
        
        <!-- èƒŒæ™¯è‰² -->
        <view class="control-item">
          <text class="control-label">èƒŒæ™¯</text>
          <input class="color-picker" type="color" value="{{backgroundColor}}" bindchange="onBackgroundColorChange"/>
        </view>
      </view>
    </view>

    <!-- å·¥å…·æ§åˆ¶ -->
    <view class="control-section" wx:if="{{selectedImages.length > 0}}">
      <view class="section-header">
        <text class="section-title">å·¥å…·</text>
      </view>
      
      <view class="tool-grid">
        <view 
          class="tool-item {{editMode && currentTool === 'text' ? 'selected' : ''}}" 
          data-tool="text" 
          bindtap="onToolSelect"
        >
          <text class="tool-icon">Aa</text>
          <text class="tool-name">æ–‡å­—</text>
        </view>
        <view 
          class="tool-item {{editMode && currentTool === 'arrow' ? 'selected' : ''}}" 
          data-tool="arrow" 
          bindtap="onToolSelect"
        >
          <text class="tool-icon">â†’</text>
          <text class="tool-name">ç®­å¤´</text>
        </view>
        <view 
          class="tool-item {{editMode && currentTool === 'rect' ? 'selected' : ''}}" 
          data-tool="rect" 
          bindtap="onToolSelect"
        >
          <text class="tool-icon">â–¢</text>
          <text class="tool-name">çŸ©å½¢</text>
        </view>
        <view 
          class="tool-item {{editMode && currentTool === 'circle' ? 'selected' : ''}}" 
          data-tool="circle" 
          bindtap="onToolSelect"
        >
          <text class="tool-icon">â—‹</text>
          <text class="tool-name">åœ†å½¢</text>
        </view>
      </view>
      
      <!-- æ–‡å­—è¾“å…¥ -->
      <view class="text-input-area" wx:if="{{editMode && currentTool === 'text'}}">
        <input class="text-input" placeholder="è¾“å…¥æ–‡å­—å†…å®¹" value="{{textInput}}" bindinput="onTextInput"/>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="bottom-actions">
      <button class="action-btn secondary" bindtap="randomLayout" wx:if="{{selectedImages.length > 1}}">
        éšæœº
      </button>
      <button class="action-btn secondary" bindtap="clearImages" wx:if="{{selectedImages.length > 0}}">
        æ¸…ç©º
      </button>
      <button class="action-btn primary" bindtap="exportImage" wx:if="{{selectedImages.length > 0}}">
        ä¿å­˜
      </button>
    </view>
    </view>
  </view>
</view>